<p align="center">
    <img src="./openapi_logo.png" width="200" height="200" alt="OpenAPI Logo"/>
</p>

<h3 align="center">CROSS OpenAPI Specification</i></h3>

---

<p align = "center">API service specification of CROSS</p>

## Structure

| File                                  |               Description                |
|:-------------------------------------------|:----------------------------------------:|
| [change-schema.py](change-schema.py)           |      Python script used for changing the schema of OpenAPI object's properties      |
| [del-endpoint.py](del-endpoint.py) |   Python script used for deleting intermediate code used for the OpenAPI specification generation process   |
| [gen-oneof.py](gen-oneof.py)                         | Python script used for converting the schema of a regular object to an oneof object |
| [gen-openapi.sh](gen-openapi.sh)                             | Bash script used for automatically generating the OpenAPI specification from Protobuf  |
| [gen-spoof-proto.py](gen-spoof-proto.py)                             | Python script used for generating intermediate code used for the OpenAPI specification generation process  |
| [openapi.html](openapi.html)                             | HTML page used for the visualization of the CROSS OpenAPI specification _(Swagger)_  |
| [openapi.yaml](openapi.yaml)                             | CROSS OpenAPI specification YAML file  |
| [swagger-yaml-to-html.py](swagger-yaml-to-html.py)                             | Python script used for generating an HTML Swagger page from the OpenAPI YAML file   |

## Automatic Procedure for Generating the OpenAPI Specification from Protobuf

Here we go into further detail regarding the use of each script used during the execution of the _gen-openapi.sh_ script responsible for generating the OpenAPI specification.

### Generate Schemas for Indirectly Used Messages

Messages defined in the proto files which are not used directly in any endpoint do not get their schemas generated. Therefore to force the generation of a particular object's schema, we utilize the _gen-spoof-proto.py_ Python script. This script generates a _virtual_ proto file used during the proto compilation process, containing _virtual_ endpoints which utilize the objects not used directly in any of the endpoints defined.

This is the script's usage:

```shell
python gen-spoof-proto.py -i <import_files_required> -o <objects_to_gen_schema>
```

The -i flag expects the filenames of the imports required by the _virtual_ file.

The -o flag expects the names of the objects which require their schemas to be generated.

### Clean the Virtual Proto File

The _gen-spoof-proto.py_ Python script generates a _virtual_ proto file containing _virtual_ endpoints which utilize the objects not used directly in any of the endpoints defined. However, the code generated by _gen-spoof-proto.py_ is only useful during the compilation process, therefore we utilize the _del-endpoint.py_ Python script to remove these _virtual_ endpoints and services

This is the script's usage:

```shell
python del-endpoint.py <objects-with-paths-to-be-deleted>
```

The script expects as argument the objects which require their schemas to be generated, in order to remove them.

### Convert Object's to Oneof Schemas

Certain messages defined in the proto files as _oneofs_ are not generated directly as _oneof_ OpenAPI objects. Therefore, we utilize the _gen-oneof.py_ Python script to convert a normal OpenAPI object's schema into an _oneof_ OpenAPI schema.

This is the script's usage:

```shell
python gen-oneof.py <object-names-to-be-converted>
```

The script expects as argument the object names which need to be converted into _oneof_.

### Change an Object's Schema

Some object fields require a different object schema other than the one used in the proto files, for example proto fields with type _any_. Therefore, we utilize the _change-schema.py_ Python script to change the schema of particular object fields.

This is the script's usage:

```shell
python change-schema.py -f <fields-to-change-schema> -s <correct-schemas>]
```

The -f flag expects the object/property of the fields which require a different schema.

The -s flag expects the correct schema of the fields referred in -f.

### Switch Oneof Schemas

Some oneof object schemas are property specific for certain applications. For example, the LocationClaim Location property can have multiple representations, however CROSS only uses the PoI. Therefore, we utilize the _switch-oneof.py_ Python script to change the schema of oneof object fields.

This is the script's usage:

```shell
python switch-oneof.py -O <objects-to-switch> -S <new-schemas> -P <new-property-names>
```

The -O flag expects the oneof objects which require a switch to default objects.

The -S flag expects the correct new schema of the objects referred in -O.

The -P flag expects the correct property name for the objects referred in -O.

### All in One Script

The _gen-openapi.sh_ script executes all of the scripts detailed above. As a concrete example, this is the command used for generating the CROSS OpenAPI specification.

```shell
./gen-openapi.sh -i Evidence.proto -o VisitEvidence,VisitEvidences -c Location -f LocationClaim/evidence -s VisitEvidences -O Location,Time -S PoI,TimeInterval -P poi,interval -p Dataset.proto,POI.proto,Route.proto,Trip.proto,User.proto,WiFiAP.proto,Evidence.proto
```

It imports the _Evidence.proto_ for the _virtual_ file, forces the generation of the schema for the objects VisitEvidence and VisitEvidences, changes the Location object's schema to a _oneof_ schema, changes the schema of the LocationClaim/evidence property to the VisitEvidences schema, switches the oneof objects Location and Time to the schemas PoI and TimeInterval, respectively, and specifies the protobuf files used for the compilation.

## Authors

| Name              | University                 | More info                                                                                                                                                                                                                                                                                                                                                                                       |
|-------------------|----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Lucas Vicente     | Instituto Superior Técnico | [<img src="https://i.ibb.co/brG8fnX/mail-6.png" width="17">](mailto:lucasdhvicente@gmail.com "lucasdhvicente@gmail.com") [<img src="https://github.githubassets.com/favicon.ico" width="17">](https://github.com/WARSKELETON "WARSKELETON") [<img src="https://i.ibb.co/TvQPw7N/linkedin-logo.png" width="17">](https://www.linkedin.com/in/lucas-vicente-a91819184/ "lucas-vicente-a91819184") |
| Rafael Figueiredo | Instituto Superior Técnico | [<img src="https://i.ibb.co/brG8fnX/mail-6.png" width="17">](mailto:rafafigoalexandre@gmail.com "rafafigoalexandre@gmail.com") [<img src="https://github.githubassets.com/favicon.ico" width="17">](https://github.com/rafafigo "rafafigo") [<img src="https://i.ibb.co/TvQPw7N/linkedin-logo.png" width="17">](https://www.linkedin.com/in/rafafigo/ "rafafigo")                               |
| Ricardo Grade     | Instituto Superior Técnico | [<img src="https://i.ibb.co/brG8fnX/mail-6.png" width="17">](mailto:ricardo.grade@tecnico.ulisboa.pt "ricardo.grade@tecnico.ulisboa.pt") [<img src="https://github.githubassets.com/favicon.ico" width="17">](https://github.com/RicardoGrade "RicardoGrade") [<img src="https://i.ibb.co/TvQPw7N/linkedin-logo.png" width="17">](https://www.linkedin.com/in/RicardoGrade "RicardoGrade")      |
